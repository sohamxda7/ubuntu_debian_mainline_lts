name: Build Mainline LTS Kernels

on:
  # Runs daily at 5:00 UTC
  schedule:
    - cron: '0 5 * * *'
  # Also allows you to run it manually from the "Actions" tab
  workflow_dispatch:

jobs:
  # JOB 1: Get the list of current LTS kernel versions
  get_versions:
    name: Get LTS Kernel Versions
    runs-on: ubuntu-latest
    outputs:
      lts_versions: ${{ steps.set_matrix.outputs.lts_versions }}
      
    steps:
      - name: Install curl and jq
        run: sudo apt-get install -y curl jq

      - name: Fetch and Parse LTS Versions
        id: set_matrix
        run: |
          echo "Fetching kernel.org releases.json..."
          JSON_ARRAY=$(curl -s https://www.kernel.org/releases.json | \
                       jq -c '[.releases[] | select(.moniker == "longterm") | .version]')
          
          echo "Found LTS versions: $JSON_ARRAY"
          echo "lts_versions=$JSON_ARRAY" >> $GITHUB_OUTPUT

  # JOB 2: Build all kernels in parallel
  build:
    name: Build Kernel ${{ matrix.kernel_version }}
    runs-on: ubuntu-latest
    needs: get_versions
    
    if: ${{ needs.get_versions.outputs.lts_versions != '[]' }}
    
    strategy:
      fail-fast: false
      matrix:
        kernel_version: ${{ fromJSON(needs.get_versions.outputs.lts_versions) }}

    steps:
      - name: 1. Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses-dev bison flex libssl-dev libelf-dev bc fakeroot dpkg-dev

      # --- THIS STEP IS NOW FIXED ---
      - name: 2. Download Kernel Source
        run: |
          KERNEL_VER=${{ matrix.kernel_version }}
          # Get major version (e.g., 6) from '6.12.56'
          KERNEL_MAJOR=$(echo $KERNEL_VER | cut -d. -f1)
          # Construct the URL as .../v6.x/...
          wget https://cdn.kernel.org/pub/linux/kernel/v$KERNEL_MAJOR.x/linux-$KERNEL_VER.tar.xz
          
          tar -xf linux-$KERNEL_VER.tar.xz
          echo "KERNEL_DIR=linux-$KERNEL_VER" >> $GITHUB_ENV

      - name: 3. Configure Kernel (Optimized, No-Debug)
        working-directory: ${{ env.KERNEL_DIR }}
        run: |
          make defconfig
          
          # --- Disable Debugging, Tracing, and Logging ---
          ./scripts/config --disable DEBUG_INFO
          ./scripts/config --disable KERNEL_DEBUG
          ./scripts/config --disable DEBUG_KERNEL
          ./scripts/config --disable FTRACE
          ./scripts/config --disable TRACING
          ./scripts/config --disable KPROBES
          ./scripts/config --disable FUNCTION_TRACER
          ./scripts/config --disable TRACER_MAX_TRACE
          ./scripts/config --disable KERNEL_GCOV
          ./scripts/config --disable GCOV_KERNEL
          ./scripts/config --disable DYNAMIC_DEBUG
          ./scripts/config --disable PRINTK
          
          # --- Set O3 Optimization ---
          ./scripts/config --enable CC_OPTIMIZE_FOR_PERFORMANCE_O3
          
          make olddefconfig
          
      - name: 4. Compile Kernel into .deb Packages
        working-directory: ${{ env.KERNEL_DIR }}
        run: |
          CPU_CORES=$(nproc)
          fakeroot make -j$CPU_CORES bindeb-pkg
          
      - name: 5. Upload Artifacts for Release Job
        uses: actions/upload-artifact@v4
        with:
          name: debs-${{ matrix.kernel_version }}
          path: ../*.deb

  # JOB 3: Create a single release *after* all builds finish
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: 1. Set Release Tag
        run: |
          RELEASE_DATE=$(date +'%Y-%m-%d')
          echo "RELEASE_TAG=lts-build-${RELEASE_DATE}" >> $GITHUB_ENV
          
      - name: 2. Download all .deb artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-debs
          
      - name: 3. Organize Files
        run: |
          mkdir release-files
          find all-debs -name "*.deb" -exec mv {} release-files/ \;
          echo "--- Files to be released: ---"
          ls release-files/

      - name: 4. Create GitHub Release and Upload Debs
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "LTS Kernel Build (${{ env.RELEASE_DATE }})"
          body: "Automated build of all dynamically fetched LTS kernels."
          files: release-files/*.deb
